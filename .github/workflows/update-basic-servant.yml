name: Update basic_servant.json Monthly

on:
  schedule:
    # 毎月1日の0:00 UTC（日本時間9:00）に実行
    - cron: '0 0 1 * *'
  workflow_dispatch: # 手動実行も可能

# ✅ OIDC 認証のために必要
permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: fgo-servant-quiz
  REGION: asia-northeast1
  BATCH_SERVICE_NAME: fgo-servant-quiz-batch

jobs:
  update-basic-servant:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------
      # Workload Identity Federation 認証
      # ------------------------------------
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      # ------------------------------------
      # gcloud CLI セットアップ
      # ------------------------------------
      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v3

      # ------------------------------------
      # バッチサービスのURLを取得
      # ------------------------------------
      - name: Get batch service URL
        id: get-url
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.BATCH_SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "Batch Service URL: $SERVICE_URL"
        env:
          CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: ${{ steps.auth.outputs.credentials_file_path }}

      # ------------------------------------
      # IDトークンを取得してAPIを呼び出し
      # ------------------------------------
      - name: Call update-basic-servant API
        run: |
          # Cloud Run サービス用のIDトークンを取得
          ID_TOKEN=$(gcloud auth print-identity-token)
          
          # APIを呼び出し
          curl -X POST \
            -H "Authorization: Bearer ${ID_TOKEN}" \
            -H "Content-Type: application/json" \
            -w "\nHTTP Status: %{http_code}\n" \
            --fail-with-body \
            ${{ steps.get-url.outputs.service_url }}/batch/update-basic-servant
        env:
          CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: ${{ steps.auth.outputs.credentials_file_path }}

      # ------------------------------------
      # 完了通知
      # ------------------------------------
      - name: Notify completion
        if: success()
        run: |
          echo "✅ basic_servant.json has been updated successfully"
          echo "Executed at: $(date -u)"

      # ------------------------------------
      # エラー通知
      # ------------------------------------
      - name: Notify failure
        if: failure()
        run: |
          echo "❌ Failed to update basic_servant.json"
          echo "Please check the logs for details"
          exit 1
