name: Deploy Backend to Cloud Run

on:
  push:
    branches:
      - main
  workflow_dispatch:

# ✅ OIDC 認証のために必要
permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: fgo-servant-quiz
  REGION: asia-northeast1
  REPOSITORY: fgo-quiz
  IMAGE_NAME: backend
  SERVICE_NAME: fgo-servant-quiz-backend

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------
      # ソースコード取得
      # ------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ------------------------------------
      # Workload Identity Federation 認証
      # ------------------------------------
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      # ------------------------------------
      # gcloud CLI セットアップ
      # ------------------------------------
      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v1

      # ------------------------------------
      # 認証確認（デバッグ用）
      # ------------------------------------
      - name: Debug GCP account
        run: |
          echo "Using creds from: ${{ steps.auth.outputs.credentials_file_path }}"
          gcloud projects describe ${{ env.PROJECT_ID }} --format="value(projectId)"
        env:
          CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: ${{ steps.auth.outputs.credentials_file_path }}

      # ------------------------------------
      # Artifact Registry 認証設定
      # ------------------------------------
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet
        env:
          CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: ${{ steps.auth.outputs.credentials_file_path }}

      # ------------------------------------
      # Docker ビルド
      # ------------------------------------
      - name: Build Docker image
        run: |
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker tag \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest

      # ------------------------------------
      # Artifact Registry へ push
      # ------------------------------------
      - name: Push Docker image
        run: |
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest
        env:
          CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: ${{ steps.auth.outputs.credentials_file_path }}

      # ------------------------------------
      # Cloud Run デプロイ
      # ------------------------------------
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --service-account ${{ secrets.GCP_SERVICE_ACCOUNT }} \
            --allow-unauthenticated \
            --add-cloudsql-instances "${{ secrets.CLOUD_SQL_INSTANCE }}" \
            --port 8080 \
            --set-env-vars "VERTEX_AI_PROJECT_ID=${{ env.PROJECT_ID }}" \
            --set-env-vars "VERTEX_AI_LOCATION=${{ env.REGION }}" \
            --set-env-vars "VERTEX_AI_MODEL=gemini-2.5-flash" \
            --set-env-vars "FRONTEND_URL=${{ secrets.FRONTEND_URL }}" \
            --set-env-vars "NODE_ENV=production" \
            --set-env-vars "DB_SOCKET_PATH=/cloudsql/${{ secrets.CLOUD_SQL_INSTANCE }}" \
            --set-env-vars "DB_HOST=localhost" \
            --set-env-vars "DB_PORT=3306" \
            --set-env-vars "DB_USER=${{ secrets.DB_USER }}" \
            --set-env-vars "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" \
            --set-env-vars "DB_NAME=${{ secrets.DB_NAME }}"
        env:
          CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: ${{ steps.auth.outputs.credentials_file_path }}

      # ------------------------------------
      # Cloud Run 環境変数を確認（名前のみ表示）
      # ------------------------------------
      - name: Verify Cloud Run environment variables
        run: |
          gcloud run services describe ${{ env.SERVICE_NAME }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --format="table(spec.template.spec.containers[0].env[].name)"
        env:
          CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: ${{ steps.auth.outputs.credentials_file_path }}
