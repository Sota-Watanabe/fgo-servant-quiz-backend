name: Deploy Backend to Cloud Run

on:
  push:
    branches:
      - main
  workflow_dispatch:

# ‚úÖ OIDC Ë™çË®º„ÅÆ„Åü„ÇÅ„Å´ÂøÖË¶Å
permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: fgo-servant-quiz
  REGION: asia-northeast1
  REPOSITORY: fgo-quiz
  IMAGE_NAME: backend
  API_SERVICE_NAME: fgo-servant-quiz-api
  BATCH_SERVICE_NAME: fgo-servant-quiz-batch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------
      # „ÇΩ„Éº„Çπ„Ç≥„Éº„ÉâÂèñÂæó
      # ------------------------------------
      - name: Checkout code
        uses: actions/checkout@v6

      # ------------------------------------
      # Node.js „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÔºà„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥ÂÆüË°åÁî®Ôºâ
      # ------------------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: package-lock.json

      # ------------------------------------
      # Workload Identity Federation Ë™çË®º
      # ------------------------------------
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      # ------------------------------------
      # gcloud CLI „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
      # ------------------------------------
      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v3

      # ------------------------------------
      # Ë™çË®ºÁ¢∫Ë™çÔºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
      # ------------------------------------
      - name: Debug GCP account
        run: |
          echo "Using creds from: ${{ steps.auth.outputs.credentials_file_path }}"
          gcloud projects describe ${{ env.PROJECT_ID }} --format="value(projectId)"
        env:
          CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: ${{ steps.auth.outputs.credentials_file_path }}

      # ------------------------------------
      # Artifact Registry Ë™çË®ºË®≠ÂÆö
      # ------------------------------------
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet
        env:
          CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: ${{ steps.auth.outputs.credentials_file_path }}

      # ------------------------------------
      # Docker „Éì„É´„Éâ
      # ------------------------------------
      - name: Build Docker image
        run: |
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker tag \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest

      # ------------------------------------
      # Artifact Registry „Å∏ push
      # ------------------------------------
      - name: Push Docker image
        run: |
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest
        env:
          CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: ${{ steps.auth.outputs.credentials_file_path }}

      # ------------------------------------
      # Âè§„ÅÑ„Ç§„É°„Éº„Ç∏„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÔºàÊúÄÊñ∞5„Å§„ÅÆ„Åø‰øùÊåÅÔºâ
      # ------------------------------------
      - name: Clean up old images
        run: |
          echo "üóëÔ∏è  Âè§„ÅÑ„Ç§„É°„Éº„Ç∏„ÇíÂâäÈô§‰∏≠ÔºàÊúÄÊñ∞5„Å§„Å®latest„Çø„Ç∞„Çí‰øùÊåÅÔºâ..."
          
          # latest „Çø„Ç∞„ÇíÈô§„ÅèÂè§„ÅÑ„Ç§„É°„Éº„Ç∏„ÇíÂâäÈô§ÔºàÊúÄÊñ∞5„Å§„ÅØ‰øùÊåÅÔºâ
          IMAGES_TO_DELETE=$(gcloud artifacts docker images list \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }} \
            --include-tags \
            --format="get(IMAGE)" \
            --sort-by="~CREATE_TIME" \
            --limit=999 | tail -n +6 | grep -v ":latest$" || true)
          
          if [ -n "$IMAGES_TO_DELETE" ]; then
            echo "$IMAGES_TO_DELETE" | while read -r image; do
              if [ -n "$image" ]; then
                echo "ÂâäÈô§: $image"
                gcloud artifacts docker images delete "$image" --quiet || true
              fi
            done
            echo "‚úÖ „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü"
          else
            echo "‚úÖ ÂâäÈô§ÂØæË±°„ÅÆ„Ç§„É°„Éº„Ç∏„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì"
          fi
        env:
          CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: ${{ steps.auth.outputs.credentials_file_path }}

      # ------------------------------------
      # TypeORM „Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥ÂÆüË°å
      # ------------------------------------
      - name: Run database migrations
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ steps.auth.outputs.credentials_file_path }}
        run: |
          set -euo pipefail
          wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy
          chmod +x cloud_sql_proxy
          ./cloud_sql_proxy -instances=${{ secrets.CLOUD_SQL_INSTANCE }}=tcp:3306 &
          PROXY_PID=$!
          trap 'kill "$PROXY_PID"' EXIT

          for attempt in {1..10}; do
            if bash -c "echo > /dev/tcp/127.0.0.1/3306" >/dev/null 2>&1; then
              echo "Cloud SQL Proxy is ready."
              break
            fi

            if [ "${attempt}" -eq 10 ]; then
              echo "Cloud SQL Proxy failed to start within expected time." >&2
              exit 1
            fi

            echo "Waiting for Cloud SQL Proxy (attempt ${attempt})..."
            sleep 2
          done

          npm ci
          npm run migrate:run

      # ------------------------------------
      # Cloud Run „Éá„Éó„É≠„Ç§
      # ------------------------------------
      - name: Deploy API service to Cloud Run
        run: |
          gcloud run deploy ${{ env.API_SERVICE_NAME }} \
            --image ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --service-account ${{ secrets.GCP_SERVICE_ACCOUNT }} \
            --allow-unauthenticated \
            --add-cloudsql-instances "${{ secrets.CLOUD_SQL_INSTANCE }}" \
            --port 8080 \
            --set-env-vars "VERTEX_AI_PROJECT_ID=${{ env.PROJECT_ID }}" \
            --set-env-vars "VERTEX_AI_LOCATION=${{ env.REGION }}" \
            --set-env-vars "VERTEX_AI_MODEL=gemini-2.5-flash" \
            --set-env-vars "FRONTEND_URL=${{ secrets.FRONTEND_URL }}" \
            --set-env-vars "NODE_ENV=production" \
            --set-env-vars "DB_SOCKET_PATH=/cloudsql/${{ secrets.CLOUD_SQL_INSTANCE }}" \
            --set-env-vars "DB_HOST=localhost" \
            --set-env-vars "DB_PORT=3306" \
            --set-env-vars "DB_USER=${{ secrets.DB_USER }}" \
            --set-env-vars "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" \
            --set-env-vars "DB_NAME=${{ secrets.DB_NAME }}" \
            --set-env-vars "GCS_BUCKET_NAME=${{ secrets.GCS_BUCKET_NAME }}" \
            --set-env-vars "CLOUD_TASKS_LOCATION=${{ env.REGION }}" \
            --set-env-vars "CLOUD_TASKS_QUEUE_NAME=${{ secrets.CLOUD_TASKS_QUEUE_NAME }}" \
            --set-env-vars "BATCH_SERVICE_URL=${{ secrets.BATCH_SERVICE_URL }}" \
            --set-env-vars "GCP_PROJECT_ID=${{ env.PROJECT_ID }}" \
        env:
          CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: ${{ steps.auth.outputs.credentials_file_path }}

      - name: Deploy batch service to Cloud Run
        run: |
          gcloud run deploy ${{ env.BATCH_SERVICE_NAME }} \
            --image ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --service-account ${{ secrets.GCP_SERVICE_ACCOUNT }} \
            --allow-unauthenticated \
            --port 8080 \
            --cpu-boost \
            --set-env-vars "NODE_ENV=production" \
            --set-env-vars "APP_ENTRY=dist/src/batch-main.js" \
            --set-env-vars "QUIZ_API_BASE_URL=${{ secrets.QUIZ_API_BASE_URL }}" \
            --set-env-vars "TWITTER_API_KEY=${{ secrets.TWITTER_API_KEY }}" \
            --set-env-vars "TWITTER_API_SECRET=${{ secrets.TWITTER_API_SECRET }}" \
            --set-env-vars "TWITTER_ACCESS_TOKEN=${{ secrets.TWITTER_ACCESS_TOKEN }}" \
            --set-env-vars "TWITTER_ACCESS_SECRET=${{ secrets.TWITTER_ACCESS_SECRET }}" \
            --set-env-vars "GCP_PROJECT_ID=${{ env.PROJECT_ID }}" \
            --set-env-vars "GCS_BUCKET_NAME=${{ secrets.GCS_BUCKET_NAME }}" \
            --set-env-vars "CLOUD_TASKS_LOCATION=${{ env.REGION }}" \
            --set-env-vars "CLOUD_TASKS_QUEUE_NAME=${{ secrets.CLOUD_TASKS_QUEUE_NAME }}" \
            --set-env-vars "BATCH_SERVICE_URL=${{ secrets.BATCH_SERVICE_URL }}"
        env:
          CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: ${{ steps.auth.outputs.credentials_file_path }}

      # ------------------------------------
      # Cloud Run Áí∞Â¢ÉÂ§âÊï∞„ÇíÁ¢∫Ë™çÔºàÂêçÂâç„ÅÆ„ÅøË°®Á§∫Ôºâ
      # ------------------------------------
      - name: Verify API service environment variables
        run: |
          gcloud run services describe ${{ env.API_SERVICE_NAME }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --format="table(spec.template.spec.containers[0].env[].name)"
        env:
          CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: ${{ steps.auth.outputs.credentials_file_path }}

      - name: Verify batch service environment variables
        run: |
          gcloud run services describe ${{ env.BATCH_SERVICE_NAME }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --format="table(spec.template.spec.containers[0].env[].name)"
        env:
          CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: ${{ steps.auth.outputs.credentials_file_path }}
